<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Crew Check-In Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body{margin:0;height:100%}
  #map{height:calc(100% - 48px)}
  #bar{display:flex;align-items:center;gap:8px;padding:6px;border-bottom:1px solid #ddd;font:14px/1.4 sans-serif}
  select,button{padding:4px 10px;font-size:14px}
  .err{color:#c00;font-size:13px}
</style>
</head>
<body>

<div id="bar">
  <label>Ch·ªçn ca:</label>
  <select id="shift"></select>
  <button id="btn">Refresh</button>
  <span id="msg" class="err"></span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/*----------------------------------------------------
  1) LINK SHEET CSV ‚Äì ch·ªâ thay ph·∫ßn ***** b√™n d∆∞·ªõi
  --------------------------------------------------*/
const ORIGIN_CSV =
 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUumGlaLtMcTsv9ImwXLbNWrgFbPLUGuKV-tTa751FpjFqWs0ZlyEZ2iCdPTvLobG4Pqub5bewVSL5/pub?gid=963908913&single=true&output=csv';

/* proxy CORS */
const CSV_URL = 'https://r.jina.ai/http://'+ ORIGIN_CSV.replace(/^https?:\/\//,'');

/*--------------------------------------------------*/
const map  = L.map('map').setView([10.5,106], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {attribution:'¬© OpenStreetMap'}
).addTo(map);

const markers = L.layerGroup().addTo(map);
const shiftSel = document.getElementById('shift');
const msg      = document.getElementById('msg');

/* ti·ªán √≠ch log + b√°o l·ªói */
const logErr = txt => { console.warn(txt); msg.textContent = txt; };

async function fetchCSV(){
  msg.textContent='ƒêang t·∫£i‚Ä¶';
  const res = await fetch(CSV_URL,{mode:'cors'});
  if(!res.ok) throw 'Fetch error: '+res.status;
  return await res.text();
}

function buildShiftList(rows){
  const set = new Set(rows.map(r=>r.ShiftCode).filter(Boolean));
  shiftSel.innerHTML =
    '<option value="">‚Äî T·∫•t c·∫£ ca ‚Äî</option>' +
    [...set].sort().map(c=>`<option>${c}</option>`).join('');
}

function drawMarkers(rows){
  markers.clearLayers();
  const need = shiftSel.value;
  rows.forEach(r=>{
    const lat = parseFloat(r.Lat), lon = parseFloat(r.Lon);
    if(!lat||!lon) return;
    if(need && r.ShiftCode!==need) return;
    L.marker([lat,lon])
     .bindPopup(`<b>${r.Email||'n/a'}</b><br>Ca: ${r.ShiftCode||''}`)
     .addTo(markers);
  });
  if(markers.getLayers().length) map.fitBounds(markers.getBounds().pad(0.2));
}

async function loadData(){
  try{
    console.log('‚ñ∂Ô∏è t·∫£i CSV', CSV_URL);
    const csv = await fetchCSV();
    Papa.parse(csv,{
      header: true,
      skipEmptyLines: true,
      // üëâ n·∫øu ch∆∞a bi·∫øt ch·∫Øc delimiter, ƒë·ªÉ dynamic:
      delimiter: (csv.indexOf(';') > csv.indexOf(',')) ? ';' : ',',
      complete: res => {
          ...
      }
    });
  }catch(e){ logErr('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: '+e); }
}

document.getElementById('btn').onclick = loadData;
/* load ngay l·∫ßn ƒë·∫ßu */
loadData();
</script>
</body>
</html>
