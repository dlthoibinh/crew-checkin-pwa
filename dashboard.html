<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Gi√°m s√°t Ca tr·ª±c</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Leaflet Fullscreen plugin CSS -->
  <link rel="stylesheet" href="https://api.maptiler.com/plugins/leaflet-fullscreen/v1.6.0/leaflet.fullscreen.css"/>
  <style>
    /* To√†n trang */
    html, body { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; bottom:60px; width:100%; }
    /* Panel ƒëi·ªÅu khi·ªÉn tr√™n c√πng */
    #control-bar {
      position:absolute; top:10px; left:50%; transform:translateX(-50%);
      background:rgba(255,255,255,0.9); padding:8px; border-radius:4px;
      display:flex; gap:8px; flex-wrap:wrap; z-index:1000;
    }
    #control-bar select, #control-bar button {
      padding:4px 8px; font-size:14px;
    }
    /* Chuy·ªÉn marker POI (v√≠ d·ª• ƒëi·ªÉm quan t√¢m) */
    .poi-layer { display:none; }
    /* Bottom navigation */
    #bottom-nav {
      position:absolute; bottom:0; left:0; right:0; height:60px;
      background:#fff; border-top:1px solid #ccc; display:flex;
    }
    #bottom-nav .nav-item {
      flex:1; text-align:center; font-size:12px; color:#555;
      display:flex; flex-direction:column; align-items:center;
      justify-content:center;
    }
    #bottom-nav .nav-item.active { color:#0088ff; }
    #bottom-nav .nav-item i {
      font-size:20px; margin-bottom:4px;
    }
  </style>
</head>
<body>

  <!-- B·∫£n ƒë·ªì -->
  <div id="map"></div>

  <!-- Thanh ƒëi·ªÅu khi·ªÉn tr√™n c√πng -->
  <div id="control-bar">
    <select id="shift">
      <option value="">-- T·∫•t c·∫£ ca --</option>
      <option>CA01</option>
      <option>CA02</option>
      <option>CA03</option>
    </select>
    <button id="btn-refresh">Refresh</button>
    <button id="btn-poi">POI</button>
  </div>

  <!-- Navigation d∆∞·ªõi c√πng -->
  <div id="bottom-nav">
    <div class="nav-item active" data-tab="monitor"><i>üó∫Ô∏è</i><span>Gi√°m s√°t</span></div>
    <div class="nav-item" data-tab="devices"><i>üìü</i><span>Thi·∫øt b·ªã</span></div>
    <div class="nav-item" data-tab="alerts"><i>‚ö†Ô∏è</i><span>C·∫£nh b√°o</span></div>
    <div class="nav-item" data-tab="account"><i>üë§</i><span>T√†i kho·∫£n</span></div>
  </div>

  <!-- Leaflet JS & Plugins -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://api.maptiler.com/plugins/leaflet-fullscreen/v1.6.0/Leaflet.fullscreen.min.js"></script>

  <script>
    // URL Google Sheet CSV
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/gviz/tq?tqx=out:csv&sheet=LOG';

    // Kh·ªüi b·∫£n ƒë·ªì
    const map = L.map('map', {
      center: [10.0,105.8],
      zoom: 10,
      scrollWheelZoom: true,
      fullscreenControl: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'¬© OpenStreetMap'
    }).addTo(map);

    // Layer ƒë·ªÉ ch·ª©a marker nh√¢n vi√™n
    const crewLayer = L.layerGroup().addTo(map);
    // Layer ƒë·ªÉ ch·ª©a POI (v√≠ d·ª• c·ªôt m·ªëc)
    const poiLayer = L.layerGroup().addTo(map);

    // Load data v√† render marker
    function loadCrew() {
      fetch(SHEET_CSV).then(r=>r.text()).then(csv=>{
        const rows = csv.trim().split('\n').slice(1).map(r=>r.split(','));
        // L·∫•y b·∫£n ghi m·ªõi nh·∫•t m·ªói email
        const latest = {};
        rows.forEach(r=>{
          const [ts,email,shift,lat,lon] = r;
          if (!email) return;
          const t = new Date(ts).getTime();
          if (!(email in latest) || t > latest[email].t) {
            latest[email] = {t,shift,lat:parseFloat(lat),lon:parseFloat(lon)};
          }
        });
        crewLayer.clearLayers();
        const filter = document.getElementById('shift').value;
        Object.entries(latest).forEach(([email,data])=>{
          if (filter && data.shift !== filter) return;
          // M√†u theo shift
          const color = data.shift==='CA01'?'red': data.shift==='CA02'?'blue':'green';
          const marker = L.circleMarker([data.lat,data.lon], {
            radius:8, fillColor:color, color:'#333', weight:1, fillOpacity:0.9
          }).addTo(crewLayer);
          marker.bindPopup(
            `<b>${email}</b><br>Ca: ${data.shift}<br>Tr·∫°ng th√°i: On-Duty`
          );
        });
      });
    }

    // V√≠ d·ª• POI tƒ©nh (v√≠ d·ª• b·ªánh vi·ªán, UBND)
    const poiData = [
      {name:'B·ªánh vi·ªán Th·ªõi B√¨nh', coords:[9.999,105.810]},
      {name:'UBND Th·ªõi B√¨nh', coords:[9.995,105.815]},
    ];
    poiData.forEach(p=>{
      L.marker(p.coords, {icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[24,24]})})
       .bindTooltip(p.name).addTo(poiLayer);
    });
    poiLayer.clearLayers(); // m·∫∑c ƒë·ªãnh t·∫Øt

    // Event
    document.getElementById('btn-refresh').onclick = loadCrew;
    document.getElementById('shift').onchange = loadCrew;
    document.getElementById('btn-poi').onclick = ()=>{
      if (map.hasLayer(poiLayer)) map.removeLayer(poiLayer);
      else poiLayer.addTo(map);
    };

    // Bottom nav (ch·ªâ gi·∫£ l·∫≠p active)
    document.querySelectorAll('#bottom-nav .nav-item').forEach(el=>{
      el.onclick =()=>{
        document.querySelectorAll('#bottom-nav .nav-item').forEach(x=>x.classList.remove('active'));
        el.classList.add('active');
        // TODO: chuy·ªÉn tab n·ªôi dung t∆∞∆°ng ·ª©ng
      };
    });

    // Ch·∫°y l·∫ßn ƒë·∫ßu
    loadCrew();
  </script>
</body>
</html>
