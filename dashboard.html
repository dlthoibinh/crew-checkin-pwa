<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Bản đồ Ca trực</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body,html{margin:0;height:100%}
  #map{height:calc(100% - 42px)}
  #bar{display:flex;gap:6px;padding:4px;background:#f7f7f7;
       box-shadow:0 1px 3px rgba(0,0,0,.15);align-items:center}
  select,button{padding:5px 9px;font-size:14px}
  #msg{font-size:14px;color:#b00}
</style>
</head>
<body>

<div id="bar">
  Chọn ca:
  <select id="shift"></select>
  <button id="btn">Refresh</button>
  <span id="msg"></span>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.5.2/papaparse.min.js"></script>
<script>
const CSV_URL =
 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUumGlaLtMcTsv9ImwXLbNWrgFbPLUGuKV-tTa751FpjFqWs0ZlyEZ2iCdPTvLobG4Pqub5bewVSL5/pub?gid=963908913&single=true&output=csv';

const map = L.map('map').setView([10.4, 105.4], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {attribution:'©OpenStreetMap'}).addTo(map);
const layer = L.layerGroup().addTo(map);

const $shift = document.getElementById('shift');
const $msg   = document.getElementById('msg');

$shift.innerHTML = '<option value="">— Tất cả ca —</option>'+
                   ['CA01','CA02','CA03'].map(c=>`<option>${c}</option>`).join('');

/* tải + vẽ */
async function load(){
  $msg.textContent='Đang tải dữ liệu';
  layer.clearLayers();
  try{
    const res = await fetch(CSV_URL,{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const csv = await res.text();
    const data = Papa.parse(csv,{header:true}).data;

    const sel = $shift.value||null;
    let bounds = [];
    data.forEach(r=>{
      if(!r.Email) return;                 // dòng trống
      if(sel && r.ShiftCode!==sel) return; // lọc ca

      let lat = parseFloat(r.Lat.toString().replace(',','.'));
      let lon = parseFloat(r.Lon.toString().replace(',','.'));
      if(isNaN(lat)||isNaN(lon)) return;

      L.marker([lat,lon])
       .bindPopup(`<b>${r.Email}</b><br>Ca: ${r.ShiftCode}`)
       .addTo(layer);
      bounds.push([lat,lon]);
    });

    if(bounds.length){
      map.fitBounds(bounds,{padding:[30,30]});
      $msg.textContent=`Hiển thị ${bounds.length} vị trí`;
    }else{
      $msg.textContent='Không có dữ liệu';
    }
  }catch(e){
    console.error(e);
    $msg.textContent='Lỗi tải dữ liệu';
    alert('Không tải được dữ liệu: '+e);
  }
}

document.getElementById('btn').onclick = load;
window.addEventListener('load',load);
</script>
</body>
</html>
