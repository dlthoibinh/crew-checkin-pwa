<!DOCTYPE html><html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Bản đồ giám sát ca trực</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>html,body,#map{height:100%;margin:0}</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API = 'https://script.google.com/macros/s/NEW_ID_HERE/exec';

const map = L.map('map').setView([16,106],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
 {attribution:'©OpenStreetMap'}).addTo(map);

async function refresh(){
  try{
    const r = await fetch(API+'?action=getPositions').then(r=>r.json());
    if(r.status!=='ok') return;
    map.eachLayer(l=>{if(l instanceof L.Marker) map.removeLayer(l);});
    const bounds=[];
    r.positions.forEach(p=>{
      const m=L.marker([p.lat,p.lng]).addTo(map)
        .bindTooltip(`${p.name}<br>${p.unit}<br>${timeAgo(p.time)}`);
      bounds.push([p.lat,p.lng]);
    });
    if(bounds.length) map.fitBounds(bounds,{padding:[20,20]});
  }catch(e){console.error(e);}
}
function timeAgo(t){
  const d=(Date.now()-new Date(t))/1000;
  if(d<60) return d.toFixed(0)+'s';
  if(d<3600) return (d/60).toFixed(0)+'m';
  return (d/3600).toFixed(1)+'h';
}
refresh(); setInterval(refresh,15000);
</script>
</body></html>
