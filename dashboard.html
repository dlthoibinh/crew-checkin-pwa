<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Dashboard – Crew Check-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body, html { margin:0; padding:0; height:100%; }
    #controls {
      height:50px; padding:8px;
      background:#f8f8f8; display:flex; align-items:center;
      gap:12px; font-family:sans-serif;
      box-shadow:0 1px 2px rgba(0,0,0,0.1);
    }
    select, button {
      padding:6px 12px; font-size:14px;
      border:1px solid #ccc; border-radius:4px;
      background:#fff; cursor:pointer;
    }
    #map { width:100%; height:calc(100% - 50px); }
  </style>
</head>
<body>

  <div id="controls">
    <label for="shift">Chọn ca:</label>
    <select id="shift">
      <option value="">— Tất cả ca —</option>
      <option>CA01</option>
      <option>CA02</option>
      <option>CA03</option>
    </select>
    <button id="refresh">Refresh</button>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // 1) Thay YOUR_GID bằng đúng gid của sheet LOG (nhìn URL khi đang mở tab LOG)
    const SHEET_GID = '0'; // ví dụ: '0' hoặc '123456789'
    const SHEET_KEY = '2PACX-1vQUumGlaLtMcTsv9ImwXLbNWrgFbPLUGuKV-tTa751FpjFqWs0ZlyEZ2iCdPTvLobG4Pqub5bewVSL5';

    // 2) URL Google Visualization API (JSONP)
    const GVIZ_URL = 
      `https://docs.google.com/spreadsheets/d/e/${SHEET_KEY}/gviz/tq?gid=${SHEET_GID}`;

    // 3) Khởi tạo map Leaflet
    const map = L.map('map').setView([10.0,106.6],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    const markers = L.layerGroup().addTo(map);

    // 4) Hàm gọi JSONP
    function loadData() {
      markers.clearLayers();
      const sel = document.getElementById('shift').value;

      // Định nghĩa callback toàn cục
      window.mySheetCallback = function(response) {
        const table = response.table;
        const cols = table.cols.map(c=>c.label);
        let latest = {};

        table.rows.forEach(r => {
          // biến form: { Timestamp, Email, ShiftCode, Lat, Lon }
          const row = {};
          cols.forEach((label,i)=> row[label] = r.c[i]?.v);
          if (!row.Email || !row.ShiftCode) return;
          if (sel && row.ShiftCode !== sel) return;

          // parse Lat/Lon (chuyển dấu phẩy)
          const lat = parseFloat( String(row.Lat).replace(',', '.') );
          const lon = parseFloat( String(row.Lon).replace(',', '.') );
          if (isNaN(lat)||isNaN(lon)) return;

          // ghi đè: dòng cuối cùng là mới nhất
          latest[row.Email] = {
            email: row.Email,
            shift: row.ShiftCode,
            when : row.Timestamp,
            lat, lon
          };
        });

        // vẽ markers
        Object.values(latest).forEach(p => {
          L.marker([p.lat,p.lon])
            .bindPopup(
              `<b>${p.email}</b><br>Ca: ${p.shift}<br>`+
              `Lúc: ${p.when}`
            )
            .addTo(markers);
        });

        // zoom
        const all = markers.getLayers();
        if (all.length) {
          map.fitBounds( L.featureGroup(all).getBounds().pad(0.2) );
        }

        // cleanup
        delete window.mySheetCallback;
      };

      // Tạo thẻ <script> JSONP, responseHandler=mySheetCallback
      const s = document.createElement('script');
      s.src = `${GVIZ_URL}&tqx=out:json&responseHandler=mySheetCallback`;
      document.body.appendChild(s);
      // tự remove thẻ sau 30s
      setTimeout(()=> document.body.removeChild(s), 30000);
    }

    document.getElementById('refresh').onclick = loadData;
    window.addEventListener('load', loadData);
  </script>
</body>
</html>
