<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard Check-In EVN</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body,html{margin:0;padding:0;height:100%}
    #controls{padding:8px;background:#fafafa;display:flex;gap:8px;align-items:center}
    #map{height:calc(100% - 48px)}
    select,input,button{padding:4px;font-size:1rem}
  </style>
</head>
<body>
  <div id="controls">
    <select id="unit"><option value="">— Đơn vị —</option></select>
    <select id="shift"><option value="">— Ca —</option><option>CA01</option><option>CA02</option><option>CA03</option></select>
    <input list="emps" id="empSearch" placeholder="Tìm nhân viên…"/>
    <datalist id="emps"></datalist>
    <button id="load">Xem</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const APP = 'https://script.google.com/macros/s/AKfycbw5dqnvTfMuMPjIkdWapz7HC9k15NiKImjhkMtPa1NymMuvtZcsf9gkfZ4BWtG2q8KkcA/exec';
    const $ = id=>document.getElementById(id);
    const map = L.map('map').setView([15.8,106],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OSM'}).addTo(map);
    let markers=L.layerGroup().addTo(map), info=L.popup();

    async function getJSON(params){
      const url=APP+'?'+new URLSearchParams(params);
      const r=await fetch(url); return r.json();
    }

    // load units
    getJSON({listUnits:1}).then(r=>{
      r.units.forEach(u=>$.unit.add(new Option(u.DienLuc,u.Ma_Dovi)));
    });

    // on unit change load employees
    $.unit.onchange = ()=>{
      $.emps.innerHTML='';
      $.empSearch.value='';
      const u=$.unit.value;
      if(!u) return;
      getJSON({listEmployees:u}).then(r=>{
        r.employees.forEach(e=>{
          const opt=document.createElement('option');
          opt.value=e.Ten_NV;
          opt.label=e.Ma_NV;
          $.emps.appendChild(opt);
        });
      });
    };

    // load logs
    $.load.onclick = async ()=>{
      markers.clearLayers();
      const unit=$.unit.value, shift=$.shift.value, emp=$.empSearch.value;
      const r=await getJSON({getLogs:1,unit,shift});
      if(r.status!=='OK'){ alert(r.message||'Lỗi'); return; }
      const pts=[];
      r.logs.forEach(l=>{
        if(emp && l.name!==emp) return;
        const m=L.marker([l.lat,l.lon]).addTo(markers);
        m.bindPopup(`<b>${l.name}</b><br>Đơn vị: ${l.unit}<br>Ca: ${l.shift}`);
        pts.push([l.lat,l.lon]);
      });
      if(pts.length){
        map.fitBounds(pts,{padding:[30,30]});
      }
    };
  </script>
</body>
</html>
