<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>Crew Check-in – Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  html,body{margin:0;height:100%}
  #bar{display:flex;gap:.6rem;align-items:center;
       padding:.4rem .6rem;background:#fafafa;
       box-shadow:0 1px 3px rgba(0,0,0,.08);
       font:15px system-ui,Arial}
  #map{height:calc(100% - 46px)}
  select,button{padding:.3rem .6rem;font-size:15px}
  #msg{font-style:italic;color:#555;margin-left:auto}
</style>
</head>
<body>

  <!-- thanh công cụ -->
  <div id="bar">
    <label>Chọn ca:&nbsp;</label>
    <select id="shift">
      <option value="">— Tất cả ca —</option>
      <option>CA01</option><option>CA02</option><option>CA03</option>
    </select>
    <button id="reload">Refresh</button>
    <span id="msg"></span>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  /* ──────────────── CẤU HÌNH ──────────────── */
  const SHEET_ID  = '1vQUumGlaLtMcTsv9ImwXLbNWrgFbPLUGuKV-tTa751FpjFqWs0ZlyEZ2iCdPTvLobG4Pqub5bewVSL5'; // thay bằng ID của anh
  const TAB_NAME  = 'LOG';           // đúng tên sheet
  const JSON_URL  = `https://opensheet.elk.sh/${SHEET_ID}/${TAB_NAME}`;
  const AUTO_REFRESH_MS = 60_000;    // 60 giây

  /* ──────────────── KHỞI TẠO ──────────────── */
  window.addEventListener('load', () => {
    /* 1. Bản đồ */
    const map = L.map('map').setView([10.3,106.2], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                {attribution:'© OpenStreetMap'}).addTo(map);
    const markers = L.layerGroup().addTo(map);

    /* 2. Tiện ích DOM */
    const $   = id => document.getElementById(id);
    const msg = t  => $('msg').textContent = t;

    /* 3. Hàm tải & hiển thị */
    async function load() {
      msg('Đang tải dữ liệu…');
      markers.clearLayers();

      try {
        const rows = await fetch(JSON_URL + '?t=' + Date.now()).then(r => r.json());
        const sel  = $('shift').value || null;
        const pts  = [];

        rows.forEach(r => {
          if (sel && r.shift !== sel) return;
          const la = +r.lat, lo = +r.lon;
          if (!la || !lo) return;
          L.marker([la, lo])
            .bindPopup(`<b>${r.email}</b><br>Ca: ${r.shift}`)
            .addTo(markers);
          pts.push([la, lo]);
        });

        if (pts.length) {
          map.fitBounds(pts, {padding:[30,30]});
          msg(`Hiển thị ${pts.length} vị trí • Cập nhật: ${new Date().toLocaleTimeString()}`);
        } else {
          msg('Không có dữ liệu phù hợp');
        }
      } catch (err) {
        console.error(err);
        alert('Không tải được dữ liệu: ' + err.message);
        msg('Lỗi tải dữ liệu');
      }
    }

    /* 4. Sự kiện & auto-refresh */
    $('reload').onclick  = load;
    $('shift').onchange  = load;
    load();                             // lần đầu
    setInterval(load, AUTO_REFRESH_MS); // tự làm mới
  });
  </script>
</body>
</html>
